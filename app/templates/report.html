{% extends "base.html" %}

{% block title %}{{ company_name }} 분석 보고서 - KORA AI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/report.css') }}">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<!-- html2pdf for PDF download -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="report-container">
    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <!-- 두근두근 대표 아이콘 -->
            <div class="loading-icon-pulse">
                <i class="fas fa-chart-line"></i>
            </div>
            
            <p class="loading-text" id="loadingText">
                <span class="company-highlight">{{ company_name }}</span>
            </p>
            <p class="loading-step" id="loadingStep">보고서를 불러오고 있어요</p>
            
            <!-- 프로세스 바 -->
            <div class="loading-progress-wrapper">
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="loadingProgressFill"></div>
                </div>
                <div class="loading-progress-steps">
                    <div class="progress-step" id="step1">
                        <div class="step-icon"><i class="fas fa-database"></i></div>
                        <span>데이터 수집</span>
                    </div>
                    <div class="progress-step" id="step2">
                        <div class="step-icon"><i class="fas fa-chart-bar"></i></div>
                        <span>지표 분석</span>
                    </div>
                    <div class="progress-step" id="step3">
                        <div class="step-icon"><i class="fas fa-robot"></i></div>
                        <span>AI 분석</span>
                    </div>
                    <div class="progress-step" id="step4">
                        <div class="step-icon"><i class="fas fa-file-alt"></i></div>
                        <span>보고서 생성</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 헤더 -->
    <header class="report-header">
        <div class="header-left">
            <a href="{{ url_for('main.main_page') }}" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="company-info-header">
                <span class="market-badge {{ market|lower }}">{{ market }}</span>
                <h1 class="company-name">{{ company_name }}</h1>
                <span class="ticker-code">{{ ticker }}</span>
            </div>
        </div>
        <div class="header-right">
            <span class="generated-time" id="generatedTime"></span>
            <button class="btn-refresh" onclick="regenerateReport()">
                <i class="fas fa-sync-alt"></i> 새로고침
            </button>
        </div>
    </header>

    <!-- 좌측 네비게이션 -->
    <nav class="report-nav" id="reportNav">
        <button class="nav-toggle-btn" onclick="toggleNav()" title="목차 숨기기">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="nav-content">
        <div class="nav-title">목차</div>
        <ul class="nav-list">
            <li><a href="#section-summary" class="nav-link active"><i class="fas fa-star"></i> 핵심 요약</a></li>
            <li><a href="#section-ai-summary" class="nav-link"><i class="fas fa-robot"></i> AI 종합 평가</a></li>
            <li><a href="#section-request" class="nav-link"><i class="fas fa-question-circle"></i> 요청사항 답변</a></li>
            <li><a href="#section-info" class="nav-link"><i class="fas fa-building"></i> 기업 정보</a></li>
            <li><a href="#section-business" class="nav-link"><i class="fas fa-briefcase"></i> 사업 분야</a></li>
            <li><a href="#section-technical" class="nav-link"><i class="fas fa-chart-bar"></i> 기술적 지표</a></li>
            <li><a href="#section-valuation" class="nav-link"><i class="fas fa-calculator"></i> 밸류에이션</a></li>
            <li><a href="#section-ratios" class="nav-link"><i class="fas fa-balance-scale"></i> 재무비율</a></li>
            <li><a href="#section-chart" class="nav-link"><i class="fas fa-chart-line"></i> 주가 차트</a></li>
            <li><a href="#section-forecast" class="nav-link"><i class="fas fa-magic"></i> 가격 예측</a></li>
            <li><a href="#section-ai-detail" class="nav-link"><i class="fas fa-clipboard-list"></i> AI 상세 평가</a></li>
            <li><a href="#section-news" class="nav-link"><i class="fas fa-newspaper"></i> 뉴스 분석</a></li>
            <li><a href="#section-disclosure" class="nav-link"><i class="fas fa-file-alt"></i> 공시 정보</a></li>
        </ul>
        </div>
        <div class="nav-collapsed-icons">
            <button class="nav-expand-btn" onclick="toggleNav()" title="목차 열기">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="nav-icon-list">
                <li><a href="#section-summary" title="핵심 요약"><i class="fas fa-star"></i></a></li>
                <li><a href="#section-ai-summary" title="AI 종합 평가"><i class="fas fa-robot"></i></a></li>
                <li><a href="#section-request" title="요청사항 답변"><i class="fas fa-question-circle"></i></a></li>
                <li><a href="#section-info" title="기업 정보"><i class="fas fa-building"></i></a></li>
                <li><a href="#section-business" title="사업 분야"><i class="fas fa-briefcase"></i></a></li>
                <li><a href="#section-technical" title="기술적 지표"><i class="fas fa-chart-bar"></i></a></li>
                <li><a href="#section-valuation" title="밸류에이션"><i class="fas fa-calculator"></i></a></li>
                <li><a href="#section-ratios" title="재무비율"><i class="fas fa-balance-scale"></i></a></li>
                <li><a href="#section-chart" title="주가 차트"><i class="fas fa-chart-line"></i></a></li>
                <li><a href="#section-forecast" title="가격 예측"><i class="fas fa-magic"></i></a></li>
                <li><a href="#section-ai-detail" title="AI 상세 평가"><i class="fas fa-clipboard-list"></i></a></li>
                <li><a href="#section-news" title="뉴스 분석"><i class="fas fa-newspaper"></i></a></li>
                <li><a href="#section-disclosure" title="공시 정보"><i class="fas fa-file-alt"></i></a></li>
            </ul>
        </div>
    </nav>

    <!-- 메인 콘텐츠 -->
    <main class="report-main">
        <!-- 섹션 1: 핵심 요약 카드 -->
        <section class="section section-summary" id="section-summary">
            <div class="summary-cards">
                <!-- 현재가 카드 -->
                <div class="summary-card current-price-card">
                    <div class="card-label">현재가</div>
                    <div class="card-value" id="currentPrice">-</div>
                    <div class="card-change" id="priceChange">-</div>
                </div>
                
                <!-- 적정주가 카드 -->
                <div class="summary-card fair-price-card">
                    <div class="card-label">
                        AI 적정주가
                        <span class="tooltip-trigger" id="fairPriceHelp">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-content" id="fairPriceTooltip">
                                산출 근거: PER/PBR 적정가치, DCF, 뉴스 감성, 재무건전성 종합 분석
                            </span>
                        </span>
                    </div>
                    <div class="card-value" id="fairPrice">-</div>
                    <div class="card-badge" id="fairPriceBadge">분석 중</div>
                </div>
                
                <!-- 투자 점수 카드 -->
                <div class="summary-card score-card">
                    <div class="card-label" id="scoreLabel">투자 점수</div>
                    <div class="score-circle" id="investmentScore">
                        <svg viewBox="0 0 100 100">
                            <circle class="score-bg" cx="50" cy="50" r="45"/>
                            <circle class="score-fill" cx="50" cy="50" r="45" id="scoreCircle"/>
                        </svg>
                        <span class="score-value" id="scoreValue">-</span>
                    </div>
                </div>
                
                <!-- 투자 의견 카드 -->
                <div class="summary-card opinion-card">
                    <div class="card-label">투자 의견</div>
                    <div class="opinion-badge" id="investmentOpinion">분석 중</div>
                    <div class="card-sub" id="opinionSub">-</div>
                </div>
            </div>
        </section>

        <!-- 섹션 2: AI 평가 요약 (상단 배치) -->
        <section class="section section-ai-summary-top" id="section-ai-summary">
            <h2 class="section-title"><i class="fas fa-robot"></i> AI 종합 평가</h2>
            <div class="ai-summary-content">
                <p class="evaluation-summary" id="evaluationSummary">
                    AI 분석을 진행 중입니다...
                </p>
            </div>
        </section>

        <!-- 섹션 2-1: 요청사항 답변 -->
        <section class="section section-request hidden" id="section-request">
            <h2 class="section-title"><i class="fas fa-question-circle"></i> 요청사항 답변</h2>
            <div class="request-question" id="requestQuestion"></div>
            <div class="request-answer">
                <div class="answer-loading" id="answerLoading">
                    <i class="fas fa-spinner fa-spin"></i> 답변을 생성 중입니다...
                </div>
                <div class="answer-content" id="answerContent"></div>
            </div>
        </section>

        <!-- 섹션 3: 기업 기본 정보 -->
        <section class="section section-info" id="section-info">
            <h2 class="section-title"><i class="fas fa-building"></i> 기업 기본 정보</h2>
            <div class="info-table-wrapper">
                <table class="info-table" id="companyInfoTable">
                    <tbody>
                        <tr><td>로딩 중...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 섹션 3-1: 사업 분야 요약 -->
        <section class="section section-business" id="section-business">
            <h2 class="section-title"><i class="fas fa-briefcase"></i> 사업 분야 요약</h2>
            <div class="business-summary-content" id="businessSummary">
                <div class="business-loading">
                    <i class="fas fa-spinner fa-spin"></i> 사업 분야 정보를 분석 중입니다...
                </div>
            </div>
        </section>

        <!-- 섹션 4: 기술적 지표 -->
        <section class="section section-technical" id="section-technical">
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> 기술적 지표</h2>
            <div class="technical-grid">
                <div class="tech-card">
                    <div class="tech-label">RSI (14)</div>
                    <div class="tech-value" id="rsiValue">-</div>
                    <div class="tech-bar">
                        <div class="bar-fill rsi" id="rsiBar"></div>
                        <div class="bar-zones">
                            <span class="zone oversold">과매도</span>
                            <span class="zone neutral">중립</span>
                            <span class="zone overbought">과매수</span>
                        </div>
                    </div>
                    <div class="tech-signal" id="rsiSignal">-</div>
                </div>
                
                <div class="tech-card">
                    <div class="tech-label">MFI (14)</div>
                    <div class="tech-value" id="mfiValue">-</div>
                    <div class="tech-bar">
                        <div class="bar-fill mfi" id="mfiBar"></div>
                        <div class="bar-zones">
                            <span class="zone oversold">과매도</span>
                            <span class="zone neutral">중립</span>
                            <span class="zone overbought">과매수</span>
                        </div>
                    </div>
                    <div class="tech-signal" id="mfiSignal">-</div>
                </div>
                
                <div class="tech-card wide">
                    <div class="tech-label">이동평균선</div>
                    <div class="ma-values">
                        <div class="ma-item"><span class="ma-label">5일</span><span class="ma-value" id="ma5">-</span></div>
                        <div class="ma-item"><span class="ma-label">20일</span><span class="ma-value" id="ma20">-</span></div>
                        <div class="ma-item"><span class="ma-label">60일</span><span class="ma-value" id="ma60">-</span></div>
                        <div class="ma-item"><span class="ma-label">120일</span><span class="ma-value" id="ma120">-</span></div>
                    </div>
                    <div class="tech-signal" id="maSignal">-</div>
                </div>
            </div>
        </section>

        <!-- 섹션 5: 밸류에이션 -->
        <section class="section section-valuation" id="section-valuation">
            <h2 class="section-title"><i class="fas fa-calculator"></i> 밸류에이션</h2>
            <div class="valuation-grid">
                <div class="val-card">
                    <div class="val-label">
                        PER
                        <span class="val-tooltip"><i class="fas fa-question-circle"></i>
                            <span class="val-tooltip-text">주가수익비율 = 주가 ÷ 주당순이익(EPS). 낮을수록 저평가 (업종평균 비교 필요)</span>
                        </span>
                    </div>
                    <div class="val-value" id="perValue">-</div>
                    <div class="val-desc">주가수익비율</div>
                </div>
                <div class="val-card">
                    <div class="val-label">
                        PBR
                        <span class="val-tooltip"><i class="fas fa-question-circle"></i>
                            <span class="val-tooltip-text">주가순자산비율 = 주가 ÷ 주당순자산(BPS). 1배 미만이면 자산가치 대비 저평가</span>
                        </span>
                    </div>
                    <div class="val-value" id="pbrValue">-</div>
                    <div class="val-desc">주가순자산비율</div>
                </div>
                <div class="val-card">
                    <div class="val-label">
                        EPS
                        <span class="val-tooltip"><i class="fas fa-question-circle"></i>
                            <span class="val-tooltip-text">주당순이익 = 당기순이익 ÷ 발행주식수. 기업의 1주당 수익</span>
                        </span>
                    </div>
                    <div class="val-value" id="epsValue">-</div>
                    <div class="val-desc">주당순이익</div>
                </div>
                <div class="val-card">
                    <div class="val-label">
                        BPS
                        <span class="val-tooltip"><i class="fas fa-question-circle"></i>
                            <span class="val-tooltip-text">주당순자산 = 자본총계 ÷ 발행주식수. 기업 청산 시 1주당 가치</span>
                        </span>
                    </div>
                    <div class="val-value" id="bpsValue">-</div>
                    <div class="val-desc">주당순자산</div>
                </div>
                <div class="val-card">
                    <div class="val-label">
                        배당수익률
                        <span class="val-tooltip"><i class="fas fa-question-circle"></i>
                            <span class="val-tooltip-text">= 주당배당금 ÷ 주가 × 100. 투자금 대비 배당 수익</span>
                        </span>
                    </div>
                    <div class="val-value" id="divYield">-</div>
                    <div class="val-desc">연간 배당률</div>
                </div>
                <div class="val-card">
                    <div class="val-label">
                        주당배당금
                        <span class="val-tooltip"><i class="fas fa-question-circle"></i>
                            <span class="val-tooltip-text">1주당 지급되는 현금배당액 (DART 사업보고서 기준)</span>
                        </span>
                    </div>
                    <div class="val-value" id="dpsValue">-</div>
                    <div class="val-desc">현금배당</div>
                </div>
                <div class="val-card">
                    <div class="val-label">52주 범위</div>
                    <div class="val-value" id="week52Range">-</div>
                    <div class="val-desc">최저 ~ 최고</div>
                </div>
            </div>
        </section>

        <!-- 섹션 5-1: 재무비율 분석 -->
        <section class="section section-financial-ratios" id="section-ratios">
            <h2 class="section-title" id="ratiosSectionTitle"><i class="fas fa-balance-scale"></i> 재무비율 분석</h2>
            <div class="ratios-container" id="ratiosContainer">
                <div class="ratio-loading">
                    <i class="fas fa-spinner fa-spin"></i> 재무비율 데이터를 불러오는 중...
                </div>
            </div>
        </section>

        <!-- 섹션: 주가 차트 -->
        <section class="section section-chart" id="section-chart">
            <div class="chart-header">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> 주가 추이</h2>
                <div class="chart-toggle">
                    <button class="chart-btn active" id="chart1y" onclick="showChart('1y')">1년 실적</button>
                    <button class="chart-btn" id="chartForecast" onclick="showChart('forecast')">1년 예측보기</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <div class="chart-legend" id="chartLegend">
                <span class="legend-item"><span class="dot price"></span> 종가</span>
                <span class="legend-item"><span class="dot ma5"></span> 5일선</span>
                <span class="legend-item"><span class="dot ma20"></span> 20일선</span>
                <span class="legend-item"><span class="dot ma60"></span> 60일선</span>
            </div>
            <p class="chart-disclaimer" id="chartDisclaimer" style="display: none;">⚠️ 미래 주가 예측은 AI 분석 기반 참고 자료이며, 실제 주가와 다를 수 있습니다.</p>
        </section>

        <!-- 섹션: 가격 예측 -->
        <section class="section section-forecast" id="section-forecast">
            <h2 class="section-title"><i class="fas fa-crystal-ball"></i> AI 가격 예측</h2>
            <div class="forecast-cards">
                <div class="forecast-card">
                    <div class="forecast-period">3개월</div>
                    <div class="forecast-price" id="forecast3m">-</div>
                </div>
                <div class="forecast-card">
                    <div class="forecast-period">6개월</div>
                    <div class="forecast-price" id="forecast6m">-</div>
                </div>
                <div class="forecast-card">
                    <div class="forecast-period">12개월</div>
                    <div class="forecast-price" id="forecast12m">-</div>
                </div>
            </div>
            <p class="forecast-disclaimer" id="forecastDisclaimer">
                ⚠️ 본 예측은 AI 분석 기반 참고 자료이며, 투자 결정의 책임은 투자자에게 있습니다.
            </p>
        </section>

        <!-- 섹션: AI 상세 평가 -->
        <section class="section section-ai-detail" id="section-ai-detail">
            <h2 class="section-title"><i class="fas fa-clipboard-list"></i> AI 상세 평가</h2>
            <div class="detail-accordion" id="detailAccordion">
                <!-- 동적으로 생성됨 -->
            </div>
        </section>

        <!-- 섹션: 뉴스 분석 -->
        <section class="section section-news" id="section-news">
            <h2 class="section-title"><i class="fas fa-newspaper"></i> 뉴스 분석</h2>
            <div class="news-header">
                <div class="news-score-card">
                    <div class="news-score-label">뉴스 감성 점수</div>
                    <div class="news-score-value" id="newsScore">-</div>
                    <div class="news-sentiment" id="newsSentiment">분석 중</div>
                </div>
                <div class="news-summary-text" id="newsSummaryText">뉴스 종합 평가를 불러오는 중...</div>
            </div>
            <div class="news-list" id="newsList">
                <div class="news-item loading">뉴스 로딩 중...</div>
            </div>
        </section>

        <!-- 섹션 10: 공시 정보 -->
        <section class="section section-disclosure" id="section-disclosure">
            <h2 class="section-title"><i class="fas fa-file-alt"></i> 최근 공시</h2>
            <div class="disclosure-list" id="disclosureList">
                <div class="disclosure-item loading">공시 로딩 중...</div>
            </div>
        </section>

        <!-- PDF 다운로드 섹션 -->
        <section class="section section-download">
            <button class="btn-pdf-download" onclick="downloadPDF()" id="downloadPdfBtnBottom">
                <i class="fas fa-file-pdf"></i>
                <span>보고서 PDF로 저장하기</span>
            </button>
        </section>
    </main>

    <!-- 모바일 채팅 토글 버튼 -->
    <button class="mobile-chat-toggle" id="mobileChatToggle" onclick="toggleMobileChat()">
        <i class="fas fa-comments"></i>
    </button>

    <!-- AI 채팅창 (PC & 모바일) -->
    <aside class="chat-sidebar" id="chatSidebar">
        <button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChat()" title="상담 숨기기">
            <i class="fas fa-chevron-right"></i>
        </button>
        <div class="chat-collapsed-icon">
            <button class="chat-reopen-btn" onclick="toggleChat()" title="상담 열기">
                <i class="fas fa-comments"></i>
            </button>
        </div>
        <div class="chat-content">
        <div class="chat-header">
            <h3><i class="fas fa-comments"></i> AI 상담</h3>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message bot">
                <div class="message-content">
                    안녕하세요! {{ company_name }} 분석 보고서에 대해 궁금한 점이 있으시면 질문해주세요.
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="질문을 입력하세요..." onkeypress="handleChatKeypress(event)">
            <button class="chat-send-btn" onclick="sendChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        </div>
    </aside>
</div>

<!-- 데이터 저장용 -->
<script>
    const COMPANY_DATA = {
        name: "{{ company_name }}",
        ticker: "{{ ticker }}",
        corpCode: "{{ corp_code }}",
        market: "{{ market }}",
        requestText: "{{ request_text|default('', true) }}"
    };
</script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/report.js') }}"></script>
{% endblock %}

